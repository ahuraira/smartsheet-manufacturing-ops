# Configuration Guide

This document details how to configure the Smartsheet Webhook Adapter for different environments (Local, Dev, Prod).

## Environment Variables

These settings are managed in `local.settings.json` for local development and in the **Azure Function App Configuration** for deployed environments.

### Core Connections
| Variable | Required | Description | Example |
|----------|:--------:|-------------|---------|
| `AzureWebJobsStorage` | Yes | Storage account for Azure Functions runtime. | `UseDevelopmentStorage=true` (Local) |
| `SERVICE_BUS_CONNECTION` | Yes | Connection string to Azure Service Bus namespace. | `Endpoint=sb://...` |
| `SERVICE_BUS_QUEUE_NAME` | Yes | Name of the primary queue. | `event-main` |
| `SQL_CONNECTION_STRING` | Yes | Connection string to Azure SQL Database. | `Driver={ODBC Driver 18 for SQL Server};Server=...` |

### Smartsheet Integration
| Variable | Required | Description |
|----------|:--------:|-------------|
| `SMARTSHEET_API_KEY` | Yes | API Access Token for the system user. |
| `SMARTSHEET_BASE_URL` | No | API Base URL. Defaults to EU. | `https://api.smartsheet.eu/2.0` |
| `WEBHOOK_CALLBACK_URL` | Yes | Publicly accessible URL of the `fn_webhook_receiver`. | `https://myapp.azurewebsites.net/api/webhook/smartsheet` |
| `SYSTEM_ACTOR_EMAILS` | No | CSV list of emails to ignore (prevents loops). | `automation@ducts.ae,system@ducts.ae` |

### Core Logic Integration
| Variable | Required | Description |
|----------|:--------:|-------------|
| `CORE_FUNCTIONS_BASE_URL` | Yes | Base URL of the Business Logic App. | `https://core-logic-app.azurewebsites.net` |
| `CORE_FUNCTIONS_KEY` | Yes | Function Access Key for the Core App. | `Host key or Function key` |
| `CORE_FUNCTIONS_TIMEOUT_SECONDS` | No | Timeout for the HTTP call. Default `30`. |

---

## Workspace Configuration (`shared/webhook_config.py`)

The application logic does not use hardcoded IDs. Instead, it uses **Logical Names** mapped to **Physical IDs**.

### Adding a New Sheet
1.  **Update Manifest:** Ensure the sheet exists in `workspace_manifest.json`. This file is usually generated by a separate infrastructure script (`fetch_manifest.py`).
2.  **Update Config:** Add an entry to `WATCHED_SHEETS_CONFIG` in `shared/webhook_config.py`.

```python
"MY_NEW_PROCESS": WatchedSheet(
    logical_name="MY_NEW_PROCESS",  # Must match key in manifest
    handler_name="process_new_logic",
    description="Description of what this monitors",
    process_attachments=True,
    watched_columns=[
        WatchedColumn("STATUS", triggers_processing=True),
        WatchedColumn("DATE", triggers_processing=True),
    ]
)
```

### Config Options
-   `process_row_created`: Trigger on new rows? (Default: `True`)
-   `process_row_updated`: Trigger on changes? (Default: `True`)
-   `process_attachments`: Trigger on file uploads? (Default: `True`)
-   `watched_columns`: List of columns. If provided, `row.updated` events are only processed if one of these columns changed.

---

## Manifest (`workspace_manifest.json`)

This file bridges the gap between human-readable names and Smartsheet's numeric IDs.

**Structure:**
```json
{
  "sheets": {
    "TAG_REGISTRY": {
      "id": 1234567890,
      "name": "02 Tag Sheet Registry",
      "columns": {
        "STATUS": { "id": 9876543210, "name": "Status" }
      }
    }
  }
}
```

**Note:** This file should be automatically updated by your CI/CD pipeline or a dedicated script whenever the Smartsheet structure changes.
