# API Reference

## External Endpoints

These endpoints are exposed by the Azure Function App.

### 1. Webhook Receiver
**URL:** `POST /api/webhook/smartsheet`
**Auth:** Anonymous (Public)

**Headers:**
-   `Smartsheet-Hook-Challenge`: (Optional) For verification handshake.
-   `Smartsheet-Hmac-SHA256`: (Optional) Signature for validation.

**Payload (Event):**
Standard Smartsheet Webhook payload.
```json
{
  "webhookId": "4503599665809284",
  "scope": "sheet",
  "scopeObjectId": "2398432489234",
  "events": [
    {
      "objectType": "row",
      "eventType": "created",
      "id": "234234234234",
      "userId": 324234234234,
      "timestamp": "2023-01-01T12:00:00Z"
    }
  ]
}
```

**Response:**
-   `200 OK`: Event received and queued.
-   `200 OK` (with body): Verification challenge response.

---

### 2. Webhook Administration
**Base URL:** `/api/webhooks`
**Auth:** Function Key (`x-functions-key` header)

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/` | List all registered webhooks. |
| `POST` | `/register` | Register webhooks for all sheets in `webhook_config.py`. |
| `POST` | `/refresh` | Re-enable any "disabled" webhooks. |
| `DELETE` | `/{id}` | Delete a specific webhook. |

---

## Internal Contracts

### Core Function Payload
When `fn_event_processor` calls the **Core Functions App**, it sends this normalized JSON payload.

**Target:** `POST /api/events/process-row`

```json
{
  "event_id": "sm_450359_202301011200_0",
  "source": "WEBHOOK_ADAPTER",
  "sheet_id": "2398432489234",
  "row_id": "234234234234",
  "column_id": "89789789789 (optional)",
  "object_type": "row", 
  "action": "CREATED", 
  "actor_id": 324234234234,
  "timestamp_utc": "2023-01-01T12:00:00Z",
  "trace_id": "trace-a1b2c3d4e5"
}
```

**Field Definitions:**
-   `event_id`: Unique ID generated by the adapter. Used for tracing.
-   `source`: Always `WEBHOOK_ADAPTER`.
-   `object_type`: `row` or `attachment`.
-   `action`: `CREATED`, `UPDATED`, `DELETED`.
-   `sheet_id`: The ID of the sheet where the event occurred.
-   `row_id`: The ID of the row affected.

### Service Bus Message
The message sent to the Service Bus queue has the same structure as the Core Function Payload.
